<!-- Copy and paste the converted output. -->

<!-----
NEW: Check the "Suppress top comment" to remove this info from the output.

Conversion time: 128.445 seconds.


Using this Markdown file:

1. Cut and paste this output into your source file.
2. See the notes and action items below regarding this conversion run.
3. Check the rendered output (headings, lists, code blocks, tables) for proper
   formatting and use a linkchecker before you publish this page.

Conversion notes:

* GDC version 1.1.19 r29
* Thu Aug 20 2020 10:01:44 GMT-0700 (Pacific Daylight Time)
* Source doc: https://docs.google.com/open?id=1IRLarrBKv2xUz9H-bwrGt0FfNAXO7_kice1HU407bfQ
----->


<p style="color: red; font-weight: bold">>>>>  GDC alert:  ERRORs: 0; WARNINGs: 0; ALERTS: 161.</p>
<ul style="color: red; font-weight: bold"><li>See top comment block for details on ERRORs and WARNINGs. <li>In the converted Markdown or HTML, search for inline alerts that start with >>>>  GDC alert:  for specific instances that need correction.</ul>

<p style="color: red; font-weight: bold">Links to alert messages:</p><a href="#gdcalert1">alert1</a>
<a href="#gdcalert2">alert2</a>
<a href="#gdcalert3">alert3</a>
<a href="#gdcalert4">alert4</a>
<a href="#gdcalert5">alert5</a>
<a href="#gdcalert6">alert6</a>
<a href="#gdcalert7">alert7</a>
<a href="#gdcalert8">alert8</a>
<a href="#gdcalert9">alert9</a>
<a href="#gdcalert10">alert10</a>
<a href="#gdcalert11">alert11</a>
<a href="#gdcalert12">alert12</a>
<a href="#gdcalert13">alert13</a>
<a href="#gdcalert14">alert14</a>
<a href="#gdcalert15">alert15</a>
<a href="#gdcalert16">alert16</a>
<a href="#gdcalert17">alert17</a>
<a href="#gdcalert18">alert18</a>
<a href="#gdcalert19">alert19</a>
<a href="#gdcalert20">alert20</a>
<a href="#gdcalert21">alert21</a>
<a href="#gdcalert22">alert22</a>
<a href="#gdcalert23">alert23</a>
<a href="#gdcalert24">alert24</a>
<a href="#gdcalert25">alert25</a>
<a href="#gdcalert26">alert26</a>
<a href="#gdcalert27">alert27</a>
<a href="#gdcalert28">alert28</a>
<a href="#gdcalert29">alert29</a>
<a href="#gdcalert30">alert30</a>
<a href="#gdcalert31">alert31</a>
<a href="#gdcalert32">alert32</a>
<a href="#gdcalert33">alert33</a>
<a href="#gdcalert34">alert34</a>
<a href="#gdcalert35">alert35</a>
<a href="#gdcalert36">alert36</a>
<a href="#gdcalert37">alert37</a>
<a href="#gdcalert38">alert38</a>
<a href="#gdcalert39">alert39</a>
<a href="#gdcalert40">alert40</a>
<a href="#gdcalert41">alert41</a>
<a href="#gdcalert42">alert42</a>
<a href="#gdcalert43">alert43</a>
<a href="#gdcalert44">alert44</a>
<a href="#gdcalert45">alert45</a>
<a href="#gdcalert46">alert46</a>
<a href="#gdcalert47">alert47</a>
<a href="#gdcalert48">alert48</a>
<a href="#gdcalert49">alert49</a>
<a href="#gdcalert50">alert50</a>
<a href="#gdcalert51">alert51</a>
<a href="#gdcalert52">alert52</a>
<a href="#gdcalert53">alert53</a>
<a href="#gdcalert54">alert54</a>
<a href="#gdcalert55">alert55</a>
<a href="#gdcalert56">alert56</a>
<a href="#gdcalert57">alert57</a>
<a href="#gdcalert58">alert58</a>
<a href="#gdcalert59">alert59</a>
<a href="#gdcalert60">alert60</a>
<a href="#gdcalert61">alert61</a>
<a href="#gdcalert62">alert62</a>
<a href="#gdcalert63">alert63</a>
<a href="#gdcalert64">alert64</a>
<a href="#gdcalert65">alert65</a>
<a href="#gdcalert66">alert66</a>
<a href="#gdcalert67">alert67</a>
<a href="#gdcalert68">alert68</a>
<a href="#gdcalert69">alert69</a>
<a href="#gdcalert70">alert70</a>
<a href="#gdcalert71">alert71</a>
<a href="#gdcalert72">alert72</a>
<a href="#gdcalert73">alert73</a>
<a href="#gdcalert74">alert74</a>
<a href="#gdcalert75">alert75</a>
<a href="#gdcalert76">alert76</a>
<a href="#gdcalert77">alert77</a>
<a href="#gdcalert78">alert78</a>
<a href="#gdcalert79">alert79</a>
<a href="#gdcalert80">alert80</a>
<a href="#gdcalert81">alert81</a>
<a href="#gdcalert82">alert82</a>
<a href="#gdcalert83">alert83</a>
<a href="#gdcalert84">alert84</a>
<a href="#gdcalert85">alert85</a>
<a href="#gdcalert86">alert86</a>
<a href="#gdcalert87">alert87</a>
<a href="#gdcalert88">alert88</a>
<a href="#gdcalert89">alert89</a>
<a href="#gdcalert90">alert90</a>
<a href="#gdcalert91">alert91</a>
<a href="#gdcalert92">alert92</a>
<a href="#gdcalert93">alert93</a>
<a href="#gdcalert94">alert94</a>
<a href="#gdcalert95">alert95</a>
<a href="#gdcalert96">alert96</a>
<a href="#gdcalert97">alert97</a>
<a href="#gdcalert98">alert98</a>
<a href="#gdcalert99">alert99</a>
<a href="#gdcalert100">alert100</a>
<a href="#gdcalert101">alert101</a>
<a href="#gdcalert102">alert102</a>
<a href="#gdcalert103">alert103</a>
<a href="#gdcalert104">alert104</a>
<a href="#gdcalert105">alert105</a>
<a href="#gdcalert106">alert106</a>
<a href="#gdcalert107">alert107</a>
<a href="#gdcalert108">alert108</a>
<a href="#gdcalert109">alert109</a>
<a href="#gdcalert110">alert110</a>
<a href="#gdcalert111">alert111</a>
<a href="#gdcalert112">alert112</a>
<a href="#gdcalert113">alert113</a>
<a href="#gdcalert114">alert114</a>
<a href="#gdcalert115">alert115</a>
<a href="#gdcalert116">alert116</a>
<a href="#gdcalert117">alert117</a>
<a href="#gdcalert118">alert118</a>
<a href="#gdcalert119">alert119</a>
<a href="#gdcalert120">alert120</a>
<a href="#gdcalert121">alert121</a>
<a href="#gdcalert122">alert122</a>
<a href="#gdcalert123">alert123</a>
<a href="#gdcalert124">alert124</a>
<a href="#gdcalert125">alert125</a>
<a href="#gdcalert126">alert126</a>
<a href="#gdcalert127">alert127</a>
<a href="#gdcalert128">alert128</a>
<a href="#gdcalert129">alert129</a>
<a href="#gdcalert130">alert130</a>
<a href="#gdcalert131">alert131</a>
<a href="#gdcalert132">alert132</a>
<a href="#gdcalert133">alert133</a>
<a href="#gdcalert134">alert134</a>
<a href="#gdcalert135">alert135</a>
<a href="#gdcalert136">alert136</a>
<a href="#gdcalert137">alert137</a>
<a href="#gdcalert138">alert138</a>
<a href="#gdcalert139">alert139</a>
<a href="#gdcalert140">alert140</a>
<a href="#gdcalert141">alert141</a>
<a href="#gdcalert142">alert142</a>
<a href="#gdcalert143">alert143</a>
<a href="#gdcalert144">alert144</a>
<a href="#gdcalert145">alert145</a>
<a href="#gdcalert146">alert146</a>
<a href="#gdcalert147">alert147</a>
<a href="#gdcalert148">alert148</a>
<a href="#gdcalert149">alert149</a>
<a href="#gdcalert150">alert150</a>
<a href="#gdcalert151">alert151</a>
<a href="#gdcalert152">alert152</a>
<a href="#gdcalert153">alert153</a>
<a href="#gdcalert154">alert154</a>
<a href="#gdcalert155">alert155</a>
<a href="#gdcalert156">alert156</a>
<a href="#gdcalert157">alert157</a>
<a href="#gdcalert158">alert158</a>
<a href="#gdcalert159">alert159</a>
<a href="#gdcalert160">alert160</a>
<a href="#gdcalert161">alert161</a>

<p style="color: red; font-weight: bold">>>>> PLEASE check and correct alert issues and delete this message and the inline alerts.<hr></p>


<p style="color: red; font-weight: bold">>>>>  GDC alert: NOTE: You have 8 H1 headings. You may want to use the "H1 -> H2" option to demote all headings by one level.</p>




<p id="gdcalert1" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image1.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert2">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image1.png "image_tooltip")



# **Virtual API Jam - API 管理**


## Labs on Github


## Updated: June, 2020 \
\_\_\_




# ラボ 1 - OpenAPI 仕様による API プロキシの設計と作成

_所要時間: 15 分_

_登場人物: API チーム_


## ユースケース

インターネットからのリクエストを受け取るためのリバース プロキシを作成し、そのリクエストを既存のサービスに転送する要件があります。デザインファーストのアプローチに従い、再利用可能なコンポーネントと、API プロキシの構築、API ドキュメントと API テストケースの生成などに使用できる仕様を、OpenAPI 仕様形式で構築することにしました。API プロキシをゼロから構築する代わりに、OpenAPI 仕様（Swagger）を使用して 、Apigee API プロキシを生成する予定です。


## Apigee Edge の利点

Apigee Edge を使用すると、サービスを API として迅速に公開できます。既存の  \
API エンドポイント、汎用 HTTP サービス、アプリケーション（Node.js など）といった、公開したいサービスのファサードを提供する _[API プロキシ](https://docs.apigee.com/api-platform/fundamentals/understanding-apis-and-api-proxies#whatisanapiproxy)_を作成することで、 \
サービスの迅速な公開が実現します。API プロキシを使用すると、デベロッパーが利用する API エンドポイントからサービス実装が切り離されます。これにより、デベロッパーは将来的なサービスへの変更から守られます。サービスに変更があってもデベロッパーには隠されているため、API の呼び出しが中断されることはありません。Apigee Edge では、API プロキシは API 管理機能を適用するためのランタイム ポリシー構成を 行う場所でもあります。。詳しくは、[API と API プロキシに関する詳細情報](https://docs.apigee.com/api-platform/fundamentals/understanding-apis-and-api-proxies#whatisanapiproxy)をご覧ください。



<p id="gdcalert2" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image2.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert3">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image2.png "image_tooltip")


Apigee Edge では _[OpenAPI 仕様](https://swagger.io/specification/)_をそのまま使用でき、API プロキシを自動的に生成できます。Apigee Edge には、OpenAPI 仕様の設計や保守に使用できる、OpenAPI 仕様の編集と保管機能が組み込まれています。



<p id="gdcalert3" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image3.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert4">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image3.png "image_tooltip")


このラボでは、以下の方法を学習します。



*   既存の HTTP サービスの OpenAPI 仕様を設計し、この仕様を Apigee Edge プラットフォーム内に格納する
*   既存の HTTP サービスに受信リクエストを転送する API プロキシを作成する


## 前提条件



*   [OpenAPI 仕様](https://github.com/OAI/OpenAPI-Specification)（Swagger）に関して基本的な知識があること
*   API をテストするための HTTP クライアント（cURL、Postman など）にアクセスできること。これらが利用できない場合は、ブラウザ ウィンドウから[こちらの REST クライアント](https://apigee-rest-client.appspot.com/)をご利用ください。


## 手順

注: このワークショップでは、複数のユーザーが共有する [Apigee 組織](https://docs.apigee.com/api-platform/fundamentals/apigee-edge-organization-structure)内で作業する場合があります。その場合、組織内のすべてのアセット名の前に自分のイニシャルを付けてください。たとえば、仕様名は {your-initials}\_{spec name}、API プロキシ名は {your-initials}\_{proxy name} のようにします。


## Open API 仕様を作成する

このラボで API エンドポイントとして公開するサンプル HTTP サービスは、http://cloud.hipster.s.apigee.com/products にある Hipster Products サービスです。 \
最初に、異なる複数のリソースのエンドポイント（/products と /products/{productId}） \
向けに OpenAPI 仕様を設計、作成します。



1. https://apigee.com/edge にアクセスしてログインします。これは Edge  \
管理 UI です。
2. 横のナビゲーション メニューから [Develop] → [Specs] を選択します。



<p id="gdcalert4" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image4.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert5">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image4.png "image_tooltip")




1. このラボでは設計済みの仕様のサンプルが利用できますので、これを  \
Apigee 組織の仕様ストアにインポートします。[+Spec] をクリックします。[Import URL] をクリックして、新しい仕様を既存のソースから追加します。



<p id="gdcalert5" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image5.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert6">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image5.png "image_tooltip")




1. 仕様の詳細を入力します。{your-initials} は自分のイニシャルに置き換えます。
    *   ファイル名: {your-initials}\_hipster\_products\_api\_spec
    *   URL: https://raw.githubusercontent.com/aliceinapiland/apijam/master/Module-1/Resources/products-catalog-spec.yaml



<p id="gdcalert6" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image6.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert7">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image6.png "image_tooltip")




1. 値を確認し、[Import] をクリックします。仕様が Apigee Edge にインポートされ、利用できるようになります。インポートした仕様がリストに表示されます。次に例を示します。



<p id="gdcalert7" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image7.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert8">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image7.png "image_tooltip")




1. リストから {your-initials}\_hipster\_products\_api\_spec をクリックすると、API の詳細と API リソースが記載されている OpenAPI 仕様エディタとインタラクティブなドキュメントにアクセスできます。



<p id="gdcalert8" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image8.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert9">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image8.png "image_tooltip")



## API プロキシを作成する



1. OpenAPI 仕様から API プロキシを作成しましょう。横のナビゲーション メニューから [Develop] → [API Proxies] をクリックします。



<p id="gdcalert9" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image9.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert10">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image9.png "image_tooltip")




1. [+Proxy] をクリックします。プロキシの構築ウィザードが表示されます。



<p id="gdcalert10" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image10.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert11">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image10.png "image_tooltip")




1. [Reverse proxy] を選択し、[Reverse proxy] オプションの下にある  \
[Use OpenAPI] をクリックします。



<p id="gdcalert11" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image11.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert12">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image11.png "image_tooltip")




1. 仕様一覧のポップアップ ダイアログが表示されます。{your-initials}\_hipster\_products\_api\_spec を選択して [ Select] をクリックします。



<p id="gdcalert12" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image12.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert13">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image12.png "image_tooltip")




1. [Reverse Proxy] オプションの下に、選択した OpenAPI 仕様の URL が表示されます。[Next] をクリックして続行します。



<p id="gdcalert13" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image13.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert14">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image13.png "image_tooltip")




1. プロキシ ウィザードに詳細を入力します。{your-initials} は自分のイニシャルに置き換えます。
    *   Proxy Name: {your\_initials}\_Hipster-Products-API
    *   Proxy Base Path: /v1/{your\_initials}\_hipster-products-api
    *   Existing API: OpenAPI 仕様から自動入力されたフィールドの値を確認します。



<p id="gdcalert14" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image14.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert15">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image14.png "image_tooltip")




1. 値を確認し、[Next] をクリックします。
2. OpenAPI 仕様から入力済みの API プロキシ リソース一覧の選択や、 \
選択解除ができます。すべてを選択して [Next] をクリックします。



<p id="gdcalert15" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image15.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert16">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image15.png "image_tooltip")




1. このプロキシではセキュリティ ポリシーを適用しないので、[Authorization] では [Pass through (none)] を選択します。[Next] をクリックします。



<p id="gdcalert16" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image16.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert17">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image16.png "image_tooltip")




1. デフォルトの仮想ホストの構成に進みます。



<p id="gdcalert17" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image17.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert18">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image17.png "image_tooltip")




1. デプロイ対象として test 環境だけが選択されていることを確認し、 \
[Build and Deploy] をクリックします。



<p id="gdcalert18" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image18.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert19">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image18.png "image_tooltip")




1. API プロキシが構築、デプロイされたら、リンクをクリックしてください。プロキシ エディタにプロキシが表示されます。



<p id="gdcalert19" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image19.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert20">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image19.png "image_tooltip")




1. _これで完了です。_既存のバックエンド サービス向けにリバース プロキシが構築されました。プロキシの [Overview] 画面が表示されます。



<p id="gdcalert20" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image20.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert21">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image20.png "image_tooltip")



## API プロキシをテストする

新たに構築された API プロキシをテストしてみましょう。cURL などのターミナル HTTP クライアントか、[こちらのサンプル REST クライアント](https://apigee-restclient.appspot.com/)などのブラウザベース クライアントを使用できます。


### cURL の使用

org には組織名を、env には API がデプロイされる環境を指定します。

curl -X GET "https://{{org}}-{{env}}.apigee.net/{{your initials}}\_hipster-products-api/products"


### サンプル REST クライアントの使用:



1. 新しいブラウザ ウィンドウで REST クライアントを開きます。
2. API プロキシの URL をコピーします。



<p id="gdcalert21" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image21.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert22">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image21.png "image_tooltip")




1. それを REST クライアントに貼り付けます。リソースパスの /products を付けて GET 呼び出しを行います。
2. 成功した場合のレスポンスは次のようになります。



<p id="gdcalert22" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image22.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert23">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image22.png "image_tooltip")



## API プロキシを保存する



1. API プロキシを API バンドルとしてローカルに保存し、他のラボで再利用できるようにします。
2. プロキシ バンドルをダウンロードして API プロキシを保存します。手順についてはスクリーンショットをご覧ください。



<p id="gdcalert23" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image23.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert24">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image23.png "image_tooltip")



## ラボの動画

動画を視聴して学習を進めるには、OpenAPI 仕様でリバース プロキシを作成する動画（https://www.youtube.com/watch?v=3XBG9QOUPzg）をご覧ください。


## さらに理解を深める

OpenAPI 仕様を使用してリバース プロキシを作成しました。[Develop] タブをクリックすると、OpenAPI 仕様から取得されるフロー条件について詳しく学ぶことができます。また、OpenAPI 仕様エディタの上部にあるリンクを使用して、OpenAPI 仕様の編集と API プロキシの生成が可能な OpenAPI 仕様エディタについて詳しく学ぶこともできます。プロキシの Overview ページにある [Trace] タブを試してみましょう。


## 理解度チェック



1. ダウンロードしたプロキシ バンドルはどのようにしてインポートしますか？
2. Apigee Edge は API のバージョニングをどのように処理しますか？
3. API プロキシを作成、更新、削除する管理 API は Apigee にありますか？


## まとめ

これでハンズオン レッスンは終了です。このラボでは、OpenAPI 仕様と Apigee Edge プロキシ ウィザードを使用して、既存のバックエンド向けにプロキシを作成する方法を学びました。


## 参考資料



*   API プロキシに関する Apigee ドキュメントのリンクをご紹介します。
    *   シンプルな API プロキシの構築 - http://docs.apigee.com/api-services/content/build-simple-api-proxy
    *   API プロキシの設計と開発に関するベスト プラクティス - http://docs.apigee.com/api-services/content/best-practices-api-proxy-design-and-development
*   「Anatomy of an API proxy」の 4 分間の動画 - https://youtu.be/O5DJuCXXIRg


# 


# ラボ 2 - Apigee Edge での API セキュリティと API プロデューサー / コンシューマの関係

_所要時間: 20 分_

_登場人物: API チーム_


## ユースケース

さまざまなアプリ（API クライアント）での利用を目指し、保護しながら公開したい API があります。API に承認済みアクセス権を設定するだけでなく、API を呼び出しているアプリを特定し、管理できる必要もあります。これで、呼び出し元を基準とする API 動作のカスタマイズ、さまざまなアプリ別の利用パターンに基づくデータ収集、分析ダッシュボードへのデータ表示が可能になります。


## Apigee Edge の利点


### API プロキシ - API プロダクト - アプリの関係

Apigee Edge では、API を保護し、コンシューマによるアクセスを管理するため、まず、API プロキシ、API プロダクト、アプリの関係を知る必要があります。

API プロキシを使用すると、API 設計仕様に対応した API エンドポイントを公開できるだけでなく、フロンドエンド（クライアント アプリ）から API バックエンド（ターゲット サービス）が分離され、API の生産と利用が分離されます。このためには API を利用する方法を定めた構成である「API プロダクト」を作成する必要があります。API プロダクト構成には、特定の API プロダクトを通じた API の利用ルールを定めたメタデータが含まれることがあります。このルールには利用が認められた割り当て量（例: 1 分あたり 100 回の API 呼び出し）、公開設定（一般、限定、内部）、API リソース制限（例: /products/{product ID} でなく、/products リソース URL のみ呼び出し可能）、呼び出し元がアクセスできる API デプロイ環境（例: test 環境や prod 環境）などが含まれています。作成された API プロダクトはクライアント アプリにサブスクライブされます。サブスクライブ時に、Apigee はアプリ用の API Key-Secret ペアを自動的に生成、プロビジョニングします。生成された認証情報を使用して、認証・認可を伴う API エンドポイントをアプリコード内から呼び出すことができます。



<p id="gdcalert24" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image24.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert25">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image24.png "image_tooltip")



## API プロキシ構成

Apigee では、さまざまな方法（[API キー](https://docs.apigee.com/api-platform/security/api-keys)、[OAuth](https://docs.apigee.com/api-platform/security/oauth/oauth-home)、[JWT トークン](https://docs.apigee.com/api-platform/reference/policies/jwt-policies-overview)、[SAML](https://docs.apigee.com/api-platform/reference/policies/saml-assertion-policy.html) など）で API を保護し、API 呼び出しを認可します。このラボではシンプルな API キー検証を使用して API を保護する方法を取り上げます。

API プロキシ内で [Verify API Key ポリシー](http://docs.apigee.com/api-services/reference/verify-api-key-policy)を使用し、API キー検証に基づいた受信 API 呼び出しを認証、認可します。API キー検証が完了すると、[Verify API Key ポリシー](https://docs.apigee.com/api-platform/reference/policies/verify-api-key-policy)によって、呼び出しを行うアプリに関する詳細、アプリのデベロッパー、呼び出しに関連する API プロダクトなどが API プロキシ ランタイム コンテキストに追加されます。このコンテキストは、クライアント アプリに基づいた割り当て量の適用やルーティングなどの API の動作に反映するため、他のポリシーのパラメータ化に使用できます。また、このデータは Apigee Analytics を通じてビジネス分析情報を取得するために抽出、使用できます。

このラボの内容



*   既存の API プロキシに [Verify API Key ポリシー](https://docs.apigee.com/api-platform/reference/policies/verify-api-key-policy)を設定し、Apigee Trace ツールを使用して動作中のポリシーを確認する
*   API プロキシを API プロダクトにバンドルする
*   この API プロダクトをサブスクライブするアプリを組織内に登録し、認可された API 利用をテストする


## 前提条件

このラボでは、現時点で保護されていない API プロキシが必要になります。利用できる API プロキシがない場合は、[API 設計: OpenAPI 仕様からリバース プロキシを作成する](https://github.com/aliceinapiland/apijam/blob/master/Module-1/Labs/Lab%201)ラボに戻って準備してから以降の手順に沿って操作してください。


## 手順


### 保護対象の API プロキシを選択してテストする



1. Apigee Edge 管理 UI（https://login.apigee.com）にログインします。 \
[Develop] → [API Proxies] に移動し、[ラボ 1](https://github.com/aliceinapiland/apijam/blob/master/Module-1/Labs/Lab%201) で作成した API プロキシ（{your\_initials}\_Hipster-Products-API）を選択します。



<p id="gdcalert25" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image25.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert26">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image25.png "image_tooltip")




2. [Overview] ページで、API プロキシが環境にデプロイされていることを確認します。選択されたリビジョンの API プロキシがデプロイされる環境は、緑色の丸で示されます。デプロイされていない場合、[Deployment] プルダウンから環境をクリックし、その環境に API プロキシをデプロイします。



<p id="gdcalert26" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image26.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert27">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image26.png "image_tooltip")




1. 組み込みの Trace ツールを使用して、呼び出しが正常に行われていることを確認します。
*   ウィンドウの上部近くにある [Trace] タブをクリックします。
*   [Trace] ビューではトレースを開始できます。最大 10 分間のトレースが可能で、その間すべてのリクエストが取り込まれ（リクエストの送信元が Trace ツールか他のクライアントかは関係ありません）、リクエストのトレースが表示されます。
*   [Start Trace Session] をクリックしてトレース セッションを開始します。
*   [前のラボ](https://github.com/aliceinapiland/apijam/blob/master/Module-1/Labs/Lab%201)で構築した API プロキシを使用している場合、同じ API 呼び出しリクエストを送信する前に、/products リソースパスを URL に追加します。[Send] をクリックしてリクエストを送信します。
*   API 呼び出しが成功すると 2xx というレスポンスが表示されます（トレース結果が表示されるまで数秒かかる場合があります）。



<p id="gdcalert27" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image27.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert28">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image27.png "image_tooltip")



## Verify API Key ポリシーを追加する



1. 横のメニューから [Develop] > [API Proxies] に移動し、API プロキシを開きます。[Develop] タブ（ページの右上）をクリックし、フローエディタを表示します（ペインを動かさないと、リクエストとレスポンスのフローラインが完全に表示されないことがあります）。
2. リクエスト フローで [+Step] をクリックします。



<p id="gdcalert28" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image28.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert29">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image28.png "image_tooltip")




1. リストの [Security] セクションから [Verify API Key] ポリシーを選択します。ポリシーの名前は変更できますが、デフォルトのままでもかまいません。[Add] をクリックします。



<p id="gdcalert29" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image29.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert30">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image29.png "image_tooltip")




*   ポリシーは、[Request] フローに以前から含まれているポリシーの後に追加されます。新たに追加されたポリシーを最初に起動したいので、このポリシーをフロー内のポリシーの左端にドラッグします。
*   [Verify API Key] ポリシーを選択すると、このポリシーの構成が表示されます（デフォルトのポリシー構成は以下のとおりです）。API キーは request.queryparam.apikey 変数としてコンテキストから取得されていることに注意してください。これがデフォルトですが、希望するパラメータからキーを取得するようにポリシーを構成できます。

            _<?xml version="1.0" encoding="UTF-8" standalone="yes"?>_


            _<VerifyAPIKey async="false" continueOnError="false" enabled="true" name="Verify-API-Key">_


            _    &lt;DisplayName>Verify API Key&lt;/DisplayName>_


            _    &lt;Properties/>_


            _    &lt;APIKey ref="request.queryparam.apikey"/>_


            _</VerifyAPIKey>_




<p id="gdcalert30" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image30.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert31">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image30.png "image_tooltip")




*   API プロキシを保存します。
1. ウィンドウの上部近くにある [Trace] タブをクリックし、[Start Trace Session] をクリックしてトレース セッションを開始します。
*   [前のラボ](https://github.com/aliceinapiland/apijam/blob/master/Module-1/Labs/Lab%201)で構築した API プロキシを使用している場合、同じ API 呼び出しリクエストを送信する前に、/products リソースパスを URL に追加します。[Send] をクリックしてリクエストを送信します。
*   API プロキシはクエリ パラメータとして API キーを期待していたので、この API 呼び出しに対しては 401（認可失敗）レスポンスが表示されます。以下のトレース セッションをご覧ください。

注: この後の手順で、この API 呼び出しを正常に完了できるようにする API キーを取得します。



<p id="gdcalert31" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image31.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert32">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image31.png "image_tooltip")



## API プロダクトを作成する



1. 横のナビゲーション メニューから [Publish] → [API Products] を選択し、 \
[+API Product] ボタンをクリックします。



<p id="gdcalert32" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image32.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert33">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image32.png "image_tooltip")




1. 以下のフィールドに入力します。

注: _他のデベロッパーが誤って変更することのないように、{{your initials}} を自分のイニシャルに置き換えてください。たとえば、API プロダクトの Name を「xx\_Hipster-Products-API-Product」などにします。_



*   セクション: Product details
    *   Name: {{your initials}}\_Hipster-Products-API-Product
    *   Display name: {{your initials}}\_Hipster Products API Product
    *   Description: Product that provides access to the Hipster Products API.
    *   Environment: test
    *   Access: Public
*   セクション: API resources
    *   セクション: API Proxies
        *   [Add a proxy] リンクをクリックします。



<p id="gdcalert33" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image33.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert34">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image33.png "image_tooltip")




    *   Hipster Products API プロキシを選択し、[Add] をクリックします。



<p id="gdcalert34" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image34.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert35">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image34.png "image_tooltip")




    *   [Add a Path] リンクをクリックし、Hipster Products API プロキシの / オプションを選択して [Add] をクリックします。



<p id="gdcalert35" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image35.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert36">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image35.png "image_tooltip")
 \


<p id="gdcalert36" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image36.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert37">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image36.png "image_tooltip")




1. 
API プロダクトを保存します。

<p id="gdcalert37" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image37.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert38">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image37.png "image_tooltip")

注: ここでは 1 つの API プロキシ全体を API プロダクトに追加しています。同じように簡単に 1 つ以上の API プロキシから 1 つ以上のオペレーションを選択し、API プロダクトにまとめてバンドルできます。


## 管理 UI からアプリを手動で登録し、API キーを生成する



1. 横のナビゲーション メニューから [Publish] → [Developers] を選択し、[+Developer] ボタンをクリックします。



<p id="gdcalert38" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image38.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert39">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image38.png "image_tooltip")




1. 以下の詳細を入力します。
    *   First Name: {{your initials}}\_Test
    *   Last Name: Developer
    *   Username: {{your initials}}\_testdev
    *   Email: {{your initials}}\_testdev@test.com
2. [Create] をクリックします。



<p id="gdcalert39" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image39.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert40">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image39.png "image_tooltip")




1. 横のナビゲーション メニューから [Publish] → [Apps] を選択し、[+App] ボタンをクリックします。



<p id="gdcalert40" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image40.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert41">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image40.png "image_tooltip")




1. 以下の詳細を入力します。
    *   Name: {{your initials}}\_Hipster-Products-App
    *   Display Name: {{your initials}}\_Hipster Products App
    *   [Developer] ラジオボタンを選択します。
    *   先ほど作成したデベロッパーを選択します。
    *   [Add Product] ボタンをクリックします。



<p id="gdcalert41" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image41.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert42">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image41.png "image_tooltip")




    *   先ほど作成した API プロダクトを選択し、[Add] をクリックします。



<p id="gdcalert42" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image42.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert43">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image42.png "image_tooltip")




2. [Create] ボタンをクリックして保存します。

 \


<p id="gdcalert43" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image43.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert44">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image43.png "image_tooltip")




3. アプリが作成されると、Apigee がこのアプリ用の API キーとシークレットのペアを生成します。キーの隣にある [Show] リンクをクリックし、この API キーをコピーしておきます。



<p id="gdcalert44" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image44.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert45">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image44.png "image_tooltip")


これで、この API キーを使用して、API プロキシに有効な API リクエストを送れるようになりました。


## 有効な API キーで API をテストする



1. 横のメニューから [Develop] > [API Proxies] に移動し、API プロキシを開きます。ウィンドウの上部近くにある [Trace] タブをクリックし、[Start Trace Session] をクリックしてトレース セッションを開始します。
2. サンプル API 呼び出しリクエストを送信する前に、/products リソースパスを URL に追加します。さらに、コピーした API キーの値を指定した apikey というクエリ パラメータを追加します。[Send] をクリックしてリクエストを送信します。
3. Verify API Key ポリシーが API キーを有効であると確認したので、API リクエストから 200 OK レスポンスが戻ります。



<p id="gdcalert45" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image45.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert46">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image45.png "image_tooltip")



## 
ラボの動画

このトピックを取り上げている動画を視聴するには、ブラウザで[こちら](https://youtu.be/3nUFCOgGlS8)を開いてください。


## 
理解度チェック



1. Verify API Key ポリシーが、通常、リクエスト PreFlow で最初のポリシーになっているのはなぜですか？このポリシーが「すべての」 PreFlow ではなく、条件付きの PreFlow に含まれることがあるのはどのような場合ですか？
2. デフォルトのクエリ パラメータの場所ではなく「Api-Key」というヘッダーから API キーを取得するには、どのようにポリシーを構成しますか？

## 
まとめ


このラボでは、API の提供側の詳細を API の利用側から隠蔽してくれる、API プロキシ、API プロダクト、アプリの関係と、Verify API Key ポリシーを使用して API プロキシを保護する方法について学びました。そしてポリシーを実装し、組み込みの Trace ツールを使用してテストを実施しました。


## 
参考資料



*   Apigee ドキュメント ページへのリンク
    *   Verify Api Key ポリシー https://docs.apigee.com/api-platform/reference/policies/verify-api-key-policy


# ラボ 3 - API 割り当て (Quota) を使って階層型 API プロダクトのサブスクリプションを管理する

所要時間: 15 分

登場人物: API プロダクト チームと API 開発チーム


## ユースケース

API 階層化はプロダクトとしての API の新しいトレンドです。階層化によってベースレベル（ブロンズなど）を無料オプションで提供します。このオファーはアップセルで提供するデータを活用するためのエントリ ポイントです。目標は追加の機能レベルにアップセルすることです。これは「フリーミアム」としても知られています。フリーミアムは非常に基本的なアプローチを採用しています。つまり、基本的な機能か、呼び出しの割り当てを入門レベルとして提供し、さらなるデータへのアクセスまたは機能を必要とする場合は有料で提供します。これにより、デベロッパーは本格的な購入を決定する前に動作するプロトタイプを作り、実際的なシナリオに基づいて API を検討できます。


## Apigee の利点

Apigee は API プロキシの機能的なロジックから抽象化された API プロダクトの概念を提供します。プロキシは API プロダクトで定義される制限値にアクセスできます。これにより、API 開発チームがこれらの制限値を使ってパラメータ化された動作を実装する一方で、API プロダクト チームは（プロダクトごとの割り当ての設定などの）ビジネス ロジックに注力できます。


## 前提条件

[ラボ 1](https://github.com/aliceinapiland/apijam/blob/master/Module-1/Labs/Lab%201) と[ラボ 2](https://github.com/aliceinapiland/apijam/blob/master/Module-1/Labs/Lab%202) を完了している場合、受講の前提条件を満たしています。

このラボを受講するためには、少なくとも「Verify API Key」ポリシーを持つデプロイ済の API プロキシと、API プロダクトにアプリを登録できるデベロッパーが必要です。


## 手順

このラボでは、付与される割り当ては異なるが同一の API プロキシをバンドルする、さまざまな API プロダクトを作成します。


## API プロダクト（ブロンズ、シルバー、ゴールド）を作成する



*   https://apigee.com/edge にアクセスしてログインします。これは Edge 管理 UI です。
*   [Publish] → [API Products] を選択します。
*   [+API Product] をクリックします。



<p id="gdcalert46" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image46.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert47">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image46.png "image_tooltip")




<p id="gdcalert47" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image47.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert48">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image47.png "image_tooltip")




*   以下のフィールドに入力します。
    *   セクション: Product details
        *   Name: {yourInitials}\_Hipster-Products-API-Product-Bronze
        *   Display name: {yourInitials}\_Hipster Products API Product Bronze
        *   Description: Free version of the Hipster Product API
        *   Environment: test
        *   Access: Public
        *   Quota: 5 requests every 1 Minute
    *   セクション: API resources
        *   [Add a proxy] リンクをクリックします。



<p id="gdcalert48" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image48.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert49">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image48.png "image_tooltip")




*   {yourInitials}\_Hipster-Products-API Proxy を選択して [Add] をクリックします。



<p id="gdcalert49" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image49.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert50">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image49.png "image_tooltip")


API プロダクトには、許可する一定期間あたりのリクエスト数（1 秒あたり 5 件のリクエストなど）を構成できる「Quota」という一連のフィールドがあります。これを構成するだけで割り当てが適用されるわけではありません。これは、次の手順で定義する Quota ポリシーが動的に読み込む定義にすぎません。



*   [Save] をクリックして API プロダクトを作成します。

続いて、異なる Quota 設定を持つ、シルバー とゴールド プロダクトを表す 2 つのよく似たプロダクトを作成します。以下の手順を実行すると、別の API プロダクトが作成されます。



*   [Publish] → [API Products] をクリックします。
*   [+API Product] をクリックします。
*   シルバー プロダクトの場合は、以下のフィールドに入力します。
    *   セクション: Product details
        *   Name: {yourInitials}\_Hipster-Products-API-Product-Silver
        *   Display name: {yourInitials}\_Hipster Products API Product Silver
        *   Description: Basic version of the Hipster Product API
        *   Environment: test
        *   Access: Public
        *   Quota: 20 requests every 1 Minute
    *   セクション: API resources
        *   [Add a proxy] リンクをクリックします。
        *   {yourInitials}\_Hipster-Products-API Proxy を選択して [Add] をクリックします。
*   ゴールド プロダクトの場合は、以下のフィールドに入力します。
    *   セクション: Product details
        *   Name: {yourInitials}\_Hipster-Products-API-Product-Gold
        *   Display name: {yourInitials}\_Hipster Products API Product Gold
        *   Description: Deluxe version of the Hipster Product API
        *   Environment: test
        *   Access: Public
        *   Quota: 1000 requests every 1 Minute
    *   セクション: API resources
        *   [Add a proxy] リンクをクリックします。
        *   {yourInitials}\_Hipster-Products-API Proxy を選択して [Add] をクリックします。

これで、プロダクト階層戦略にマッチした、3 つの API プロダクトが作成されました。



<p id="gdcalert50" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image50.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert51">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image50.png "image_tooltip")



## 各プロダクト用のアプリを作成する



*   [Publish] → [Apps] を選択します。
*   [+API Product] をクリックします。



<p id="gdcalert51" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image51.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert52">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image51.png "image_tooltip")




<p id="gdcalert52" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image52.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert53">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image52.png "image_tooltip")




*   以下のフィールドに入力します。
    *   セクション: App Details
        *   Name: {yourInitials}\_Hipster Android App Free
        *   Display name: {yourInitials}\_Hipster Android App Free
        *   Developer: 既存のデベロッパーを選択します。
    *   セクション: Credentials
        *   [Add product] をクリックします。



<p id="gdcalert53" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image53.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert54">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image53.png "image_tooltip")




*   Hipster Product API Product Bronze を選択して [Add] をクリックします。



<p id="gdcalert54" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image54.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert55">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image54.png "image_tooltip")




*   [Create] をクリックしてアプリを作成します。
*   アプリのプロパティで [Show] をクリックし、後から使用する場合に備えてキーを記録しておきます。



<p id="gdcalert55" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image55.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert56">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image55.png "image_tooltip")


以下の値を使用して、シルバー枠とゴールド枠を使用するアプリでプロセスを繰り返します。



*   シルバー API プロダクトを使用するアプリ
    *   セクション: App Details
        *   Name: {yourInitials}\_Hipster Android App Basic
        *   Display name: {yourInitials}\_Hipster Android App Basic
        *   Developer: 既存のデベロッパーを選択します。
    *   セクション: Credentials
        *   [Add product] をクリックします。
        *   Hipster Product API Product Silver を選択して [Add] をクリックします。
*   ゴールド API プロダクトを使用するアプリ
    *   セクション: App Details
        *   Name: {yourInitials}\_Hipster Android App Deluxe
        *   Display name: {yourInitials}\_Hipster Android App Deluxe
        *   Developer: 既存のデベロッパーを選択します。
    *   セクション: Credentials
        *   [Add product] をクリックします。
        *   Hipster Product API Product Gold を選択して [Add] をクリックします。

これで異なる 3 つの API キーを持つアプリが 3 つ作成されました。キーは記録しておいてください。



<p id="gdcalert56" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image56.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert57">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image56.png "image_tooltip")



## Quota ポリシーを作成して構成する

上記で説明したように、Quota ポリシーをプロキシに追加しないと割り当てが適用されません。API プロダクトの Quota フィールドの構成により、プロキシ内で使える必要な変数が設定され、Quota ポリシーで読み込めるようになります。



1. 横のナビゲーション メニューから [Develop] → [API Proxies] をクリックします。前提条件にあった、既存の API プロキシを開きます。
2. Verify API Key のポリシーが正しい名前で存在していることを確認します。ポリシー名をクリックして下記の XML 構成を確認します。



<p id="gdcalert57" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image57.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert58">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image57.png "image_tooltip")




1. [PreFlow] と [+ Step] をクリックし、新しいポリシーを追加します。



<p id="gdcalert58" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image58.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert59">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image58.png "image_tooltip")




1. [Quota] ポリシーをクリックし、以下のフィールドに入力します。
    1. Display Name: QU-ProductQuota

[Add] をクリックしてフローにポリシーを追加します。



<p id="gdcalert59" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image59.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert60">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image59.png "image_tooltip")




1. 前提条件の VAK-VerifyKey で構成した VerifyAPIKey ポリシーにより、API キーが検証されます。API キーが、[Quota] フィールドに「1 分あたり 3 件のリクエスト」と設定された API プロダクトを含むため、検証後に以下の変数が設定されます。

        _verifyapikey.VAK-VerifyKey.apiproduct.developer.quota.limit = 3_


        _verifyapikey.VAK-VerifyKey.apiproduct.developer.quota.interval = 1_


        _verifyapikey.VAK-VerifyKey.apiproduct.developer.quota.timeunit = minute_


次に、上記の変数を参照し、ポリシー構成でこのコードを使用する QU-ProductQuota という Quota ポリシーを設定します。


        _<?xml version="1.0" encoding="UTF-8" standalone="yes"?>_


        _<Quota async="false" continueOnError="false" enabled="true" name="QU-ProductQuota" type="calendar">_


        _  &lt;DisplayName>QU-ProductQuota&lt;/DisplayName>_


        _  &lt;Allow count="3" countRef="verifyapikey.VAK-VerifyKey.apiproduct.developer.quota.limit"/>_


        _  &lt;Interval ref="verifyapikey.VAK-VerifyKey.apiproduct.developer.quota.interval">1&lt;/Interval>_


        _  &lt;TimeUnit ref="verifyapikey.VAK-VerifyKey.apiproduct.developer.quota.timeunit">minute&lt;/TimeUnit>_


        _  &lt;Identifier ref='verifyapikey.VAK-VerifyKey.client\_id'/>_


        _  &lt;Distributed>true&lt;/Distributed>_


        _  &lt;Synchronous>true&lt;/Synchronous>_


        _  &lt;StartTime>2019-01-01 12:00:00&lt;/StartTime>_


        _</Quota>_



<p id="gdcalert60" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image60.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert61">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image60.png "image_tooltip")


注: API プロダクトで [Quota] フィールドが 設定されていない場合、ここでのデフォルト値である「1 分あたり 3 件の呼び出し」が使用されます。



1. 前の手順でポリシーを変更したら、[Save] をクリックします。



<p id="gdcalert61" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image61.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert62">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image61.png "image_tooltip")



## 結果をテストする

API プロキシに移動し、[Trace] タブでいくつかのテストを実行できます。



*   [Trace] をクリックします。
*   [Start Trace Session] をクリックします。
*   ブロンズ apikey 値を URL にクエリ パラメータとして追加します（例: http://{yourapigeeorg}-test.apigee.net/v1/{yourInitials}\_hipster-products-api/products?apikey=GYuZekimsQ2TLdWWMHkqB1poAquHaGsv）。
*   [Send] ボタンを複数回クリックしてテストを行います。



<p id="gdcalert62" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image62.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert63">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image62.png "image_tooltip")




*   呼び出しが 6 回に達し、Quota の 5 回の無料呼び出しを超過すると、Quota ポリシーに赤の感嘆符記号が表示されます。



<p id="gdcalert63" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image63.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert64">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image63.png "image_tooltip")


次に API プロダクトを切り替え、アプリのシルバー apikey 値を URL にクエリ パラメータとして追加します（例: http://{yourapigeeorg}-test.apigee.net/v1/{yourInitials}\_hipster-products-api/products?apikey=GYuZekimsQ2TLdWWMHkqB1poAquHaGsv）。



*   apikey パラメータをシルバーアプリの認証情報に一致するように変更します。
*   [Start Trace Session] をクリックする前に、[Send] ボタンを 15 回前後クリックしてテストを行います。
*   トレース セッションを開始し、上限に到達する前に [Send] ボタンを再び複数回クリックします。

トレース結果を確認してみましょう。



*   左側に表示されている成功したトレース結果（ステータスが緑色の 200 のもの）の 1 つをクリックします。
*   [Transaction Map] の Quota ポリシー アイコンをクリックします。



<p id="gdcalert64" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image64.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert65">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image64.png "image_tooltip")




*   最後の呼び出しでは、元の 20 回（ratelimit.QU-ProductQuota.allowed.count）のうち、1 回だけが使用可能（ratelimit.QU-ProductQuota.available.count）であることがわかります。
*   プロキシフローに含まれる使用可能な他の変数についても見てみましょう。

ここでは、デラックス またはゴールド バージョンのプロダクトについては省略しますが、デベロッパーがこのバージョンのプロダクトの上限には簡単に到達しないことがわかるでしょう。


## 
理解度チェック



*   Quota ポリシーで [Identifier] タグを省略すると、どうなるでしょうか？

## 
まとめ


このラボでは、階層化モデルを提供し、プロダクトごとに異なる割り当てを付与するという、API プロダクト戦略に沿った 3 つのプロダクトを作成しました。API プロキシ内では制限を定義せず、API プロダクトで割り当て量を定めることで、同じプロキシを利用できるようにしました。


## 
参考資料


### Apigee ドキュメントへのリンク

https://docs.apigee.com/api-platform/reference/policies/quota-policy


## 動画（4mv4d）

https://www.youtube.com/watch?v=z8Rj\_VzSbh4

https://www.youtube.com/watch?v=1RDDpH0wOdc


# 


# ラボ 4 - Apigee 統合デベロッパー ポータルを使用したアプリ デベロッパー エクスペリエンスの構築

_所要時間: 30 分_

_登場人物: API チーム_


## ユースケース

デベロッパー ポータルから API プロダクトを利用するアプリ デベロッパー向けに、簡単なセルフサービス オンボーディング エクスペリエンスを提供し、管理することを目指します。アプリ デベロッパーが API について学び、利用登録し、API を使い始められるようにすると同時に、さまざまな API プロダクトの可視性とアクセスを管理します。


## Apigee Edge の利点

Apigee Edge にはデベロッパー ポータル向けに複数のオプションが用意されています。Apigee は、シンプルなターンキー ソリューションから、完全にカスタマイズ可能で拡張可能なソリューションまで、多様なデベロッパー ポータル ソリューションをサポートしています。ターンキー[統合デベロッパー ポータル](https://docs.apigee.com/api-platform/publish/portal/build-integrated-portal) オプションは、テーマ、ロゴ、ページ コンテンツなど、サイトの多くのブランディングとカスタマイズをサポートします。このオプションは管理 UI から直接、数秒で公開できます。[Drupal ベースのポータル](https://docs.apigee.com/api-platform/publish/drupal/open-source-drupal-8)も提供しており、こちらではより完全な管理と、Drupal マーケットの何百もの Drupal モジュールを活用が可能です。このラボでは統合デベロッパー ポータルを取り上げます。


## デベロッパー プログラム、チーム、オーディエンスの管理

Apigee Edge では、[デベロッパー プログラム](https://docs.apigee.com/api-platform/publish/portal/intro-developer-program)はデベロッパー ポータルごとに関連付けられる構成セットです。具体的には、アプリのデベロッパー アカウント、アプリのデベロッパー ID 管理構成、アプリのデベロッパー チーム、ポータルに公開されるコンテンツにアクセスするためのオーディエンス構成が含まれます。

アプリのデベロッパーは、他のデベロッパーとアプリの責任を共有する[チーム](https://docs.apigee.com/api-platform/publish/portal/developer-teams)を作成することもできます。チーム内の各デベロッパーには、共有するアプリへのアクセスレベルを定義するロール（オーナー、アプリの管理者、閲覧者）が割り当てられます。

[オーディエンス](https://docs.apigee.com/api-platform/publish/portal/portal-audience)構成は、次のリソースへのアクセス権を管理するため、ユーザーまたはデベロッパー チームを分割するために使用されます。



*   ポータル内のページ
*   公開済みの API プロダクト

次の図は、一連のリソースへのアクセス権を管理するためにオーディエンスがどのように使用されているかを示しています。



<p id="gdcalert65" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image65.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert66">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image65.png "image_tooltip")


このラボでは、API プロダクトの公開先である統合デベロッパー ポータルを作成します。このポータルで、アプリのデベロッパーは以下のことが可能です。



*   OpenAPI 仕様ベースのインタラクティブなドキュメントで API の利用方法を学習
*   API プロダクトを利用するアプリの登録
*   API 利用のためのアプリのクライアント認証情報（API キーとシークレット）を生成


## 前提条件

このモジュールの[ラボ 1](https://github.com/aliceinapiland/apijam/blob/master/Module-1/Labs/Lab%201)、[ラボ 2](https://github.com/aliceinapiland/apijam/blob/master/Module-1/Labs/Lab%202)、[ラボ 3](https://github.com/aliceinapiland/apijam/blob/master/Module-1/Labs/Lab%203) の受講を完了している必要があります。

以下の準備が必要です。



*   組織内の仕様ストアに OpenAPI 仕様をアップロードしておきます。この仕様から API のドキュメントを生成します。このラボで使用できる OpenAPI 仕様がない場合は、_[ラボ 1 - OpenAPI 仕様による API プロキシの設計と作成](https://github.com/aliceinapiland/apijam/blob/master/Module-1/Labs/Lab%201)_をもう一度受講してください。
*   API プロキシをバンドルした API プロダクト。API プロダクトが構成されていない場合は、_[ラボ 2 - Apigee Edge での API セキュリティと API プロデューサー / コンシューマの関係](https://github.com/aliceinapiland/apijam/blob/master/Module-1/Labs/Lab%202)_と[ラボ 3 - API 呼び出し割り当てから階層型 API プロダクトのサブスクリプションを管理する](https://github.com/aliceinapiland/apijam/blob/master/Module-1/Labs/Lab%203)をもう一度受講してください。


## 手順


### CORS サポートのために API プロキシを更新する

CORS（クロスオリジン リソース シェアリング）は、非オリジン ドメインのリソースとやり取りするウェブページで実行される、JavaScript XMLHttpRequest（XHR）呼び出しを許可するための標準のメカニズムです。CORS は、あらゆるブラウザで実施されている[同一オリジン ポリシー](https://ja.wikipedia.org/wiki/%E5%90%8C%E4%B8%80%E7%94%9F%E6%88%90%E5%85%83%E3%83%9D%E3%83%AA%E3%82%B7%E3%83%BC)に対して一般的に実装されているソリューションです。たとえば、ブラウザで実行される JavaScript コードから API プロキシに XHR 呼び出しを行うと、この呼び出しは失敗します。これは、ブラウザにそのページを提供しているドメインが、API を提供しているドメイン（{your org name}-{environment name}.apigee.net など）と同じでないためです。CORS は、クロスオリジン リソース シェアリングの提供を希望しているサーバーに「オプトイン」することを許可することで、この問題に対するソリューションを提供します。

この手順では、API プロキシがインタラクティブなドキュメント ページ内で呼び出されるデベロッパー ポータルに公開される前に、API プロキシに対して CORS サポートを実装している必要があります。

詳細については、[API プロキシに CORS サポートを追加する](https://docs.apigee.com/api-platform/develop/adding-cors-support-api-proxy)をご覧ください。



1. 
[Develop] → [API Proxies] に移動し、API プロキシ "{your initials}\_Hipster-Products-API" を選択します。このプロキシの [Develop] タブを開き、プロキシ構成を編集します。 \


<p id="gdcalert66" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image66.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert67">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image66.png "image_tooltip")



2. ポリシーの左側のパネルで [+] オプションを選択し、新しいポリシーを追加します。

 \


<p id="gdcalert67" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image67.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert68">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image67.png "image_tooltip")


[Assign Message] オプションを選択し、次の詳細のポリシーを追加します。 \
Display Name: Set CORS Response Headers Name: Set-CORS-Response-Headers \


<p id="gdcalert68" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image68.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert69">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image68.png "image_tooltip")
 \
次のようにポリシー構成を編集します。


    _```_


    _<?xml version="1.0" encoding="UTF-8" standalone="yes"?>_


    _<AssignMessage async="false" continueOnError="false" enabled="true" name="Set-CORS-Response-Headers">_


    _ &lt;DisplayName>Set CORS Response Headers&lt;/DisplayName>_


    _ &lt;FaultRules/>_


    _ &lt;Properties/>_


    _ &lt;Set>_


    _   &lt;Headers>_


    _     &lt;Header name="Access-Control-Allow-Origin">{request.header.origin}&lt;/Header>_


    _     &lt;Header name="Access-Control-Allow-Headers">origin, x-requested-with, accept, content-type&lt;/Header>_


    _     &lt;Header name="Access-Control-Max-Age">3628800&lt;/Header>_


    _     &lt;Header name="Access-Control-Allow-Methods">GET, PUT, POST, DELETE&lt;/Header>_


    _   &lt;/Headers>_


    _ &lt;/Set>_


    _ &lt;IgnoreUnresolvedVariables>true&lt;/IgnoreUnresolvedVariables>_


    _ &lt;AssignTo createNew="false" transport="http" type="response"/>_


    _</AssignMessage>_


    _```_

 \


<p id="gdcalert69" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image69.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert70">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image69.png "image_tooltip")




3. 上記の手順 2 と 3 を繰り返し、次の詳細の Assign Message ポリシーを追加します。 \
Display Name: Set OPTIONS Status Code Name: Set-OPTIONS-Status-Code \
Policy configuration: 

    <?xml version="1.0" encoding="UTF-8" standalone="yes"?>


    <AssignMessage async="false" continueOnError="false" enabled="true" name="Set-OPTIONS-Status-Code">


    <DisplayName>Set OPTIONS Status Code&lt;/DisplayName>


    <Properties/> 


    <AssignVariable> 


    <Name>error.status.code&lt;/Name> &lt;Value>200&lt;/Value> 


    </AssignVariable> 


    <IgnoreUnresolvedVariables>true&lt;/IgnoreUnresolvedVariables> 


    <AssignTo createNew="false" transport="http" type="request"/> 


    </AssignMessage>

4. 左側のパネルの [Target Endpoint] -> [default] の下にある [PreFlow] フローを選択します。次の図のように、[Set CORS Response Headers] ポリシーをフローのレスポンス パイプラインにドラッグ＆ドロップします。

 \


<p id="gdcalert70" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image70.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert71">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image70.png "image_tooltip")
 \
これであらゆる有効な API 呼び出しで CORS ヘッダーが返されるようになります。



5. [+] ボタンを選択して左側のパネルの [Proxy Endpoint] -> [default] にフローを追加します。

 \


<p id="gdcalert71" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image71.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert72">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image71.png "image_tooltip")




6. [Manual] エントリタブを選択し、以下のフロー詳細を入力します。 \
Flow Name: OptionsPreFlight Description: For CORS preflight requests Condition Type: Custom Condition: request.verb == "OPTIONS"

 \


<p id="gdcalert72" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image72.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert73">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image72.png "image_tooltip")
 \
[Add] をクリックします。 \
このフローは CORS Preflight OPTIONS リクエストを処理します。



7. 
左側のパネルの [Proxy Endpoint] -> [default] の下にある [OptionsPreFlight] フローを選択します。次の図のように、[Set CORS Response Headers] ポリシーをフローのレスポンス パイプラインにドラッグ＆ドロップします。


<p id="gdcalert73" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image73.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert74">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image73.png "image_tooltip")
 \


これで CORS Preflight OPTIONS リクエストに対して CORS ヘッダーが返されます。

左側のパネルの [Proxy Endpoint] -> [default] を選択します。構成の下部までスクロール ダウンし、 'default' ルールの前に、以下のような [RouteRule](https://docs.apigee.com/api-platform/fundamentals/understanding-routes#determiningtheurlofthetargetendpoint) 設定を追加します。 \


<p id="gdcalert74" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image74.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert75">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image74.png "image_tooltip")
 \



    _<RouteRule name="NoRoute">_


    _  &lt;Condition>request.verb == "OPTIONS"&lt;/Condition>_


    _</RouteRule>_

 \
この RouteRule により、CORS Preflight OPTIONS リクエストは API ターゲット サービスに転送されなくなります。

左側のパネルの [Proxy Endpoint] -> [default] を選択します。構成の最上部にスクロールし、次の図のように、[DefaultFaultRule](https://docs.apigee.com/api-platform/fundamentals/fault-handling#creatingfaultrules-creatingadefaultfaultrule) 設定を追加します。


    _<DefaultFaultRule name="DefaultFaultRule">_


    _  &lt;Step>_


    _    &lt;Name>Set-CORS-Response-Headers&lt;/Name>_


    _  &lt;/Step>_


    _  &lt;Step>_


    _    &lt;Name>Set-OPTIONS-Status-Code&lt;/Name>_


    _    &lt;Condition>request.verb = "OPTIONS"&lt;/Condition>_


    _  &lt;/Step>_


    _  &lt;AlwaysEnforce>true&lt;/AlwaysEnforce>_


    _</DefaultFaultRule>_

これで、API プロキシエラーが起きた場合でも、CORS ヘッダーが正しく返され、CORS Preflight OPTIONS リクエストは常に処理されます。たとえば、API キーの検証が失敗した場合などでもです。


## OpenAPI 仕様を更新する

API プロキシ経由で公開される API エンドポイントを正確に記述した、最新の OpenAPI 仕様を用意するため、最初に仕様を修正する必要があります。具体的には、host, basepath, securityDefinitions, security, schemes の各プロパティを変更します。これを行うには、メインメニューで [Develop] → [Specs] に移動し、ラボ 1 で以前インポートした仕様を選択して、次の図のように、host, basepath, securityDefinitions, security, schemes の各プロパティを変更します。


    _host: {{your API proxy host}}  _


    _basePath: /{{your initials}}\_hipster-products-api_


    _securityDefinitions:_


    _  APIKeyQuery:_


    _    type: "apiKey"_


    _    in: "query"_


    _    name: "apikey"_


    _security:_


    _  - APIKeyQuery: []_


    _schemes:_


    _  - https_


## デベロッパー ポータルを作成する



1. [Publish] → [Portals] に移動し、[+Portal] または [Get started]（組織内にまだポータルを作成していない場合）をクリックします。



<p id="gdcalert75" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image75.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert76">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image75.png "image_tooltip")




1. ポータル作成ウィザードに詳細を入力します。{{your-initials}} は自分のイニシャルに置き換えます。
*   Name: {{your initials}}\_Hipster API Portal
*   Description: Developer portal for consumption of Hipster APIs.
1. [Create] をクリックします。



<p id="gdcalert76" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image76.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert77">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image76.png "image_tooltip")



## ブロンズ（無料）API プロダクトをポータルに公開する



1. ポータル エディタのプルダウンをクリックして [APIs] を選択します。



<p id="gdcalert77" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image77.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert78">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image77.png "image_tooltip")




1. [+API] をクリックして、ポータルに公開するブロンズ API プロダクトを選択します。公開する API プロダクトを選択し、[Next] をクリックします。



<p id="gdcalert78" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image78.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert79">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image78.png "image_tooltip")




1. [Change Spec Source] プルダウンをクリックして [Choose a different spec...] を選択します。



<p id="gdcalert79" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image79.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert80">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image79.png "image_tooltip")




1. ソースとして使用する、先ほど更新した OpenAPI 仕様を選択します。選択した OpenAPI 仕様の最新バージョン（スナップショット）を使って、ポータル内にこの API プロダクトのドキュメントを生成します。



<p id="gdcalert80" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image80.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert81">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image80.png "image_tooltip")




1. [Registered users] オプションを選択すると、デベロッパー ポータルに登録済みのデベロッパーだけが、ポータルを通じてこの API を表示できるようになります。[Next] をクリックします。



<p id="gdcalert81" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image81.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert82">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image81.png "image_tooltip")




1. [Image] ボタンを選択して、この API プロダクトに関連付けられているアイコン イメージを更新します。



<p id="gdcalert82" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image82.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert83">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image82.png "image_tooltip")




1. [External Image] を選択し、イメージをインポートする以下の URL を指定します。
*   Image URL:  \
https://raw.githubusercontent.com/aliceinapiland/apijam/master/Module-1/Labs/Lab%204/media/HipsterAPIProductImage.png



<p id="gdcalert83" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image83.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert84">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image83.png "image_tooltip")




1. [Finish] をクリックします。



<p id="gdcalert84" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image84.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert85">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image84.png "image_tooltip")


これでデベロッパー ポータルに API プロダクトが公開されました。


## アプリ デベロッパーの登録



1. [Live Portal] リンクをクリックし、ブラウザタブまたはウィンドウで新たなデベロッパー ポータルを開きます。



<p id="gdcalert85" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image85.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert86">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image85.png "image_tooltip")




1. デベロッパー ポータルで [Sign In] メインメニュー オプションをクリックします。アプリ デベロッパーのログインページが表示されます。ここで [Create Account] をクリックします。



<p id="gdcalert86" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image86.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert87">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image86.png "image_tooltip")




<p id="gdcalert87" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image87.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert88">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image87.png "image_tooltip")


次の詳細情報を指定し、[Create Account] をクリックします。


    _ \
First Name: {{your first name}}_


    _Last Name: {{your last name}}_


    _Email: {{your email address}}_


    _Password: {{enter a password}}_


    _[I agree to terms.] チェックボックスをオンにします。_



<p id="gdcalert88" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image88.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert89">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image88.png "image_tooltip")




1. アカウントの作成時に、アプリ デベロッパーはアカウントの検証リンクが含まれたメール通知を受け取ります。



<p id="gdcalert89" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image89.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert90">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image89.png "image_tooltip")


このラボでは、自分のメールアドレスをアプリ デベロッパーとして提供しているので、この通知を受け取るはずです。通知リンクをクリックまたはブラウザに貼り付け、アカウントを検証します。



<p id="gdcalert90" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image90.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert91">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image90.png "image_tooltip")




2. アカウントが検証されると、アプリ デベロッパーは認証情報を使用してポータルにログインできます。



<p id="gdcalert91" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image91.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert92">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image91.png "image_tooltip")



## API ドキュメントを表示する



1. 前の手順で作成したアカウントの認証情報を使用してアプリのデベロッパーとしてログインします。デベロッパー ポータルで [APIs] メニューリンクをクリックします。API カタログのページが表示されます。先ほど公開した API プロダクトが、登録されているすべてのデベロッパーに表示されていることがわかります。



<p id="gdcalert92" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image92.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert93">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image92.png "image_tooltip")




1. カタログのブロンズ プロダクトの API プロダクト アイコンをクリックし、ドキュメントを表示します。API プロダクトの公開時に関連付けられた OpenAPI 仕様から生成されるインタラクティブなドキュメント ページが表示されます。



<p id="gdcalert93" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image93.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert94">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image93.png "image_tooltip")




1. ドキュメントの左側のパネルから API リソースパスのいずれか 1 つを選択し、[Execute] をクリックします。右側のパネルに未承認レスポンス 401 が表示されます。

 \


<p id="gdcalert94" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image94.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert95">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image94.png "image_tooltip")
 \
このレスポンスは、登録されているアプリがなく、認可された API 呼び出しに使用する API キーがないために表示されます。


## アプリを登録する



1. 画面右上隅のデベロッパー アカウントのプルダウン メニューに移動し、[Apps] リンクを選択します。



<p id="gdcalert95" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image95.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert96">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image95.png "image_tooltip")




2. [New App] ボタン（このページ上か、以下のように上部パネルにあります）をクリックします。

 \


<p id="gdcalert96" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image96.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert97">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image96.png "image_tooltip")




3. アプリの詳細を次のように入力し、[Create] をクリックします。

    App Name: {{your initials}}\_Hipster-Test-App Description: Test app to try out Hipster Products API using the Bronze (Free) API Product \



    サブスクリプションで使用できるブロンズ（無料の）API プロダクトを選択します。 \


<p id="gdcalert97" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image97.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert98">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image97.png "image_tooltip")


4. 新たに作成されたアプリに API Key-Secret ペアが生成されます。これで、この API キーを使用して API をテストできるようになりました。



<p id="gdcalert98" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image98.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert99">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image98.png "image_tooltip")




5. API カタログに移動し、ブロンズ API プロダクトのドキュメントを選択して GET /products リソースをもう一度テストします。今回のテストでは、[Authorize] ボタンを最初にクリックし、新たに作成されたアプリの認証情報を選択して、API 呼び出しの認可情報（API キー）を設定します。



<p id="gdcalert99" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image99.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert100">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image99.png "image_tooltip")
 \
認可情報が設定されたら [OK] をクリックします。 \


<p id="gdcalert100" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image100.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert101">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image100.png "image_tooltip")


 \
今度は [Execute] をクリックします。有効な 200 OK API レスポンスを受け取ります。



<p id="gdcalert101" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image101.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert102">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image101.png "image_tooltip")



## チーム機能とオーディエンス管理機能を有効にする



1. チーム機能とオーディエンス管理機能を利用するには、最初に Apigee Edge 組織でベータ プログラムに参加する必要があります。それには、管理 UI で [Publish] -> [Developer Programs] に移動し、統合デベロッパー ポータルに関連付けられているデベロッパー プログラムを選択します。

 \


<p id="gdcalert102" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image102.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert103">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image102.png "image_tooltip")




2. [Enroll] ボタンをクリックして、「チームとオーディエンス管理のベータ版に参加」します。



<p id="gdcalert103" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image103.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert104">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image103.png "image_tooltip")
 \
参加が完了すると、デベロッパー プログラム内でチーム機能とオーディエンス管理機能が使用できるようになります。



<p id="gdcalert104" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image104.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert105">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image104.png "image_tooltip")



## 
**デベロッパー チームを作成する**



1. 自分のアプリのデベロッパー認証情報でデベロッパー ポータルにログインしていることを確認します。アカウントのプルダウンから [Teams] メニューに移動します。



<p id="gdcalert105" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image105.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert106">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image105.png "image_tooltip")




1. [+ New Team] ボタンをクリックします。



<p id="gdcalert106" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image106.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert107">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image106.png "image_tooltip")


チームの詳細を入力して [Create] をクリックします。

 \
[Overview] セクション: \* Team name: {{your initials}}\_Hipster App Team \* Description: Team that will work together on Hipster apps, and share API Keys. \* Point of contact: {your App Developer email address}

Members:  \
 アプリのデベロッパーのメール ID がすでに「オーナー」ロールでチームに追加されています。

 必要に応じて、別のロールのデベロッパーを追加できます。

 \


<p id="gdcalert107" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image107.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert108">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image107.png "image_tooltip")




2. チームが作成されると、デベロッパー ポータルからチームのメンバーとして、 \
このチームにアクセスできるようになります。 API プロデューサーとしては、Apigee 管理 UI 内のデベロッパー プログラムで、作成されたチームを見ることができます。



<p id="gdcalert108" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image108.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert109">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image108.png "image_tooltip")
 \


<p id="gdcalert109" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image109.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert110">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image109.png "image_tooltip")



## オーディエンスを作成する

特定のオーディエンスだけが表示したりサブスクライブできるような形で、デベロッパー ポータルに API プロダクトを公開する方法について説明します。



1. [Publish]→ [Developer Programs] → {デベロッパー ポータルに関連付けられているデベロッパー プログラム} に移動します。[Audiences] タブをクリックし、[+] ボタンをクリックして新しいオーディエンスを追加します。

     \


<p id="gdcalert110" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image110.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert111">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image110.png "image_tooltip")



    詳細を次のように入力し、[OK] をクリックします。 \



    Name: Hipster-API-Privileged-Audience Description: A privileged audience that is allowed access to the Hispter API Silver and Gold products.


    

<p id="gdcalert111" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image111.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert112">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image111.png "image_tooltip")


2. オーディエンスが作成されたら、オーディエンスに割り当てられるチームを定義します。これを行うには、オーディエンスの [Assignments] セクションで [+] ボタンをクリックします。

 \


<p id="gdcalert112" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image112.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert113">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image112.png "image_tooltip")
 \
ポップアップに、直前に作成したチームの名前を入力します。チームを選択して [Add(1)] をクリックします。

 \


<p id="gdcalert113" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image113.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert114">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image113.png "image_tooltip")
 \
[Save] をクリックしてオーディエンスの割り当てを保存します。 \


<p id="gdcalert114" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image114.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert115">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image114.png "image_tooltip")



## 新しいオーディエンス資格に対応したシルバー API プロダクトを公開する



1. [Publish] → [Portals] → {{your developer portal}} → [APIs] に移動し、[+API] ボタンをクリックします。



<p id="gdcalert115" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image115.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert116">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image115.png "image_tooltip")




1. シルバー API プロダクトを選択して [Next] をクリックします。



<p id="gdcalert116" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image116.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert117">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image116.png "image_tooltip")




1. [Generate docs from] プルダウンをクリックして [Choose a different spec...] を選択します。



<p id="gdcalert117" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image117.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert118">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image117.png "image_tooltip")




1. ソースとして使用する、最近更新した OpenAPI 仕様を選択します。選択した OpenAPI 仕様の最新バージョン（スナップショット）でポータル内にこの API プロダクトのドキュメントを生成します。



<p id="gdcalert118" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image118.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert119">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image118.png "image_tooltip")




1. [Published] チェックボックスがオンになっていることを確認します。これで、アプリの作成時に API カタログから、シルバー API プロダクトが承認されたアプリのデベロッパーに公開されます。次に [Next] をクリックします。



<p id="gdcalert119" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image119.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert120">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image119.png "image_tooltip")




1. [Image] ボタンを選択して、この API プロダクトに関連付けられているアイコン イメージを更新します。



<p id="gdcalert120" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image120.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert121">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image120.png "image_tooltip")




1. [External Image] を選択し、イメージをインポートする以下の URL を指定します。

    Image URL:  \
https://raw.githubusercontent.com/aliceinapiland/apijam/master/Module-1/Labs/Lab%204/media/HipsterAPIProductImage.png


次に [Add] をクリックします。



<p id="gdcalert121" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image121.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert122">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image121.png "image_tooltip")




1. [Finish] をクリックします。



<p id="gdcalert122" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image122.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert123">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image122.png "image_tooltip")




1. シルバー API プロダクトの [Audience Visibility] アイコンをクリックします。



<p id="gdcalert123" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image123.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert124">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image123.png "image_tooltip")




1. [Restricted access] オプションを選択し、作成したオーディエンスのチェックボックスをオンにします。[Submit] をクリックします。



<p id="gdcalert124" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image124.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert125">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image124.png "image_tooltip")



## チームアプリを作成する



1. デベロッパー ポータルで、画面右隅のデベロッパー アカウントのプルダウン メニューに移動し、[Apps] リンクを選択します。[New App] ボタンをクリックします。



<p id="gdcalert125" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image125.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert126">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image125.png "image_tooltip")




2. アプリの詳細を次のように入力し、[Create] をクリックします。

        App Name: {{your initials}}\_Hipster App 


        Description: App that is registered against the team to share App credentials and access Silver tier Hipster API product. 


        Owner: {{your initials}}\_Hipster App Team \



サブスクリプションに使用できるシルバー（無料の）API プロダクトを選択します。 \


<p id="gdcalert126" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image126.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert127">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image126.png "image_tooltip")




3. 新たに作成されたアプリに API Key-Secret ペアが生成されます。これで、この API キーを使用して API をテストできるようになりました。

 \


<p id="gdcalert127" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image127.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert128">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image127.png "image_tooltip")




4. [API Catalog] に移動し、シルバー API プロダクトのドキュメントを選択します。



<p id="gdcalert128" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image128.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert129">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image128.png "image_tooltip")




5. GET /products リソースを選択します。[Authorize] ボタンをクリックし、新たに作成したチームアプリの認証情報を選択して、API 呼び出しの認可情報（API キー）を設定します。ポップアップから [Authorize] をクリックします。



<p id="gdcalert129" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image129.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert130">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image129.png "image_tooltip")
 \
認可情報が設定されたら [OK] をクリックします。 \


<p id="gdcalert130" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image130.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert131">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image130.png "image_tooltip")
 \


[Execute] をクリックします。有効な 200 OK API レスポンスを受け取ります。 \


<p id="gdcalert131" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image131.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert132">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image131.png "image_tooltip")



## ラボの動画

このトピックを取り上げている動画を視聴するには、ブラウザで[こちら](https://youtu.be/_gDpzDJPNQg)を開いてください。


## さらに理解を深める



*   ポータルに 2 番目のプロダクトを追加し、ライブポータルを起動してこのプロダクトをテストします。
*   自分の API 仕様を更新し、その仕様の[スナップショットを取得](https://docs-new.apigee.com/publish-apis#take-snapshot)して、ポータルのドキュメントを更新します。


## 理解度チェック



1. 複数の API プロダクトをデベロッパー ポータルに公開する理由を 2 つ挙げてください。
2. OpenAPI 仕様に加えられた変更は、デベロッパー ポータルに自動的に反映されます。正しいか誤りかを選んでください。


## まとめ

以下について学びました。



*   Apigee の軽量デベロッパー ポータルのデプロイ
*   OpenAPI 仕様付きでの API プロダクトの公開
*   デベロッパー ポータル UI を使用して OpenAPI 仕様のスナップショットをデベロッパーとして閲覧


# 


# ラボ 5 - Apigee Analytics で API プログラムの成果を評価する

_所要時間: 15 分_

_登場人物: API プロダクト チーム_


## ユースケース


### 最初の API プロダクト公開後の流れ

いくつかの API プロダクトの稼働開始後は、次の点について、プログラムがどのように実行され、API プロダクトが正常に動作しているかどうか確認する必要があります。



*   トラフィックは長期的にどのような傾向があるか。
*   トラフィックが最大となっているのはいつか。
*   ユーザーが最も多い場所はどこか。
*   最もアクティブなデベロッパーは誰か。


### 分析情報によるキャパシティ プランニングのサポート

キャパシティ プランニングを実行する必要があるとき、利用トレンドデータを使って、API 呼び出しの長期的な傾向を観察し、次の年のトラフィック予測を立てることができます。

Apigee 組み込みの分析機能によってデータを可視化することで、API の傾向とパターンの理解をサポートします。


### トラフィックと API プロダクトの連携



<p id="gdcalert132" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image132.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert133">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image132.png "image_tooltip")


アプリケーションを API プロダクトに登録すると、API キーまたは OAuth トークンの検証時にメタデータが読み込まれ、デベロッパー、アプリ、プロダクトが識別できるようになります。このデータはプログラムに関する分析情報にとって重要です。


### 前提条件



*   前のモジュールを受講していれば、そのモジュールで作成したプロキシに対するトラフィックがある程度あり、前の API プロキシをカスタム統計に使用できることがあります。
*   受講していなくてもこのラボを受講できますが、ダッシュボードに表示されるデータは少なくなります。
*   （省略可）フル エクスペリエンスを試したい場合、ダッシュボードのデータを閲覧する前に、負荷生成ツールを設定します。


### （省略可）API プロキシに負荷を加える

前のモジュールを受講していない場合、負荷生成ツールを使用してレポートにデータを加えることができます。

デフォルトの API キーポリシーと 3 つの API キーを持つ API プロキシが用意されていると、さまざまなアプリと API プロダクトを容易に作成できます。


### 負荷生成ツールを構成して実行する

このリポジトリ内の loadgen フォルダにあるプロキシをアップロードすることで、新しいプロキシを作成できます。



1. [Develop] > [API Proxies] > [+ Proxy] の順にクリックして新しいプロキシを作成します。
2. 新しいプロキシ ウィザードでプロキシ バンドルのアップロードを選択し、リポジトリから .zip ファイルをアップロードします。この .zip ファイルは[こちら](https://github.com/aliceinapiland/apijam/blob/master/Module-1/Labs/Lab%205/loadgen/LoadGen-Proxy.zip?raw=true)からダウンロードします。



<p id="gdcalert133" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image133.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert134">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image133.png "image_tooltip")




<p id="gdcalert134" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image134.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert135">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image134.png "image_tooltip")




1. [Build] をクリックします。
2. プロキシが作成されたら、それをエディタで直接開き、[Develop] タブに移動してプロキシと API キー関連の値を変更します。左側のパネルの [Resources] セクションで config/model.json リソースに移動し、以下のように値を変更します。



<p id="gdcalert135" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image135.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert136">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image135.png "image_tooltip")




1. 値を変更したら、プロキシを保存してデプロイし、[Trace] タブからプロキシを実行します。
2. しばらく負荷生成ツールを実行しておき、プロキシによるトラフィックの生成を停止するときはプロキシをデプロイ解除します。


## ビルトインの Apigee Analytics ダッシュボードを使用して API の使用状況を把握する

Apigee には数多くの組み込みレポートが用意されています。このラボの目的のため、また時間を節約するため、稼働中のデモ環境から取得したスクリーンショットで、さまざまなダッシュボードをご紹介します。各自の環境で手順を実行する場合は、オプションの負荷生成ツールを使用してください。

動画で API ダッシュボードの確認を希望する場合は、こちらをご覧ください。数多くの値が入力済みの、さまざまな指標のダッシュボードの概要が紹介されています。https://youtu.be/mElNO44QQFQ?t=126

レポートに移動するにはサイドバーの [Analyze] メニューを開きます。



<p id="gdcalert136" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image136.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert137">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image136.png "image_tooltip")



## API プロキシのパフォーマンス

[Proxy Performance] ダッシュボードは、API プロキシのトラフィック パターンと処理時間を確認するために役立ちます。API によって生成されるトラフィックの量と API 呼び出しの処理にかかる時間（Apigee Edge で受信されてからクライアント アプリに返されるまで）を簡単に可視化できます。



<p id="gdcalert137" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image137.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert138">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image137.png "image_tooltip")



## キャッシュのパフォーマンス

[Cache Performance] ダッシュボードでは、Apigee Edge キャッシュの値を一目で確認できます。このダッシュボードは、レイテンシの短縮とバックエンド サーバーの負荷の軽減の観点から、キャッシュの効果を可視化するために役立ちます。



<p id="gdcalert138" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image138.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert139">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image138.png "image_tooltip")



## エラーコード分析

[Error Code Analysis] ダッシュボードには、API プロキシおよびターゲットのエラー率に関する情報が表示されます。[Error Code Analysis] ダッシュボードの表示は次のとおりです。



*   プロキシエラーはレスポンス コードを使用して計算
*   ターゲット エラーはターゲットからのレスポンス コードを使用して計算



<p id="gdcalert139" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image139.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert140">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image139.png "image_tooltip")



## ターゲットのパフォーマンス

[Target Performance] ダッシュボードは、API プロキシの バックエンド ターゲットのトラフィック パターンとパフォーマンス指標を可視化します。



<p id="gdcalert140" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image140.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert141">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image140.png "image_tooltip")



## デベロッパーのエンゲージメント

[Developer Engagement] ダッシュボードでは、最も多くの API トラフィックを生成している登録済みのアプリデベロッパーがわかります。デベロッパーごとに、誰が最も多くの API トラフィックと最も多くのエラーを生成しているかを調べることができます。たとえば、特定のデベロッパーのアプリが他のデベロッパーに比べて多くのエラーを発生している場合は、そのデベロッパーの問題にプロアクティブに対処できます。



<p id="gdcalert141" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image141.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert142">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image141.png "image_tooltip")


メインビューが使用できる場合、アプリの [Actions] 列の下にある [Analyze] ボタンを選択し、アプリとアプリのデベロッパーに関する詳細を表示できます。以下のグラフが表示されます。



<p id="gdcalert142" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image142.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert143">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image142.png "image_tooltip")



## トラフィック構成

[Traffic Composition] ダッシュボードでは、API プログラム全体に対する上位の API、アプリ、デベロッパー、プロダクトの影響を相対的に測定します。



<p id="gdcalert143" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image143.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert144">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image143.png "image_tooltip")



## デバイス

[Device] ダッシュボードには、API へのアクセスに使用されているデバイスやサーバーに関する情報が表示されます。ユーザーが API にどのようにアクセスしているか、傾向をつかむことができます。たとえば、特定のタイプのデバイスからのトラフィックの増加や減少を把握して、変化に伴いアクションが必要となるかどうかを判断できます。



<p id="gdcalert144" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image144.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert145">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image144.png "image_tooltip")



## Geomap

[Geo Map] ダッシュボードでは、さまざまな地理的場所のトラフィック パターン、 \
エラーパターン、サービス品質を追跡できます。すべての API に関する情報を表示することも、特定の API の情報に絞り込むこともできます。



<p id="gdcalert145" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image145.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert146">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image145.png "image_tooltip")



## 
カスタム分析レポートを作成する


### Statistics Collector を追加する



1. 横のナビゲーション メニューから [Develop] → [API Proxies] をクリックします。前のラボで作成した Hipster プロダクトの API プロキシを開き、[Develop] タブに移動します。
2. パスからデータを取得するには、最初にこれを Apigee Flow 変数に抽出する必要があります。それには、Extract Variables ポリシーを追加します。
3. [GetProductDetails] フローで [+ Step] ボタンをクリックして、リクエストに新しいステップを追加します。



<p id="gdcalert146" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image146.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert147">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image146.png "image_tooltip")




1. [Mediation] カテゴリの下にある [Extract Variables] ポリシーを追加します。



<p id="gdcalert147" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image147.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert148">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image147.png "image_tooltip")




1. [Mediation] カテゴリの下にある [Extract Variables] ポリシーを追加します。

        _<ExtractVariables name="ExtractVariables-1">_


        _   &lt;DisplayName>EV-ExtractProductID &lt;/DisplayName>_


        _   &lt;Source>request&lt;/Source>_


        _   &lt;URIPath>_


        _      &lt;Pattern ignoreCase="true">/products/{productId}&lt;/Pattern>_


        _   &lt;/URIPath>_


        _   &lt;VariablePrefix>urirequest&lt;/VariablePrefix>_


        _   &lt;IgnoreUnresolvedVariables>true&lt;/IgnoreUnresolvedVariables>_


        _</ExtractVariables>_

1. [GetProductDetails] で [+ Step] ボタンをクリックして、リクエストに新しいステップを追加します。



<p id="gdcalert148" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image148.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert149">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image148.png "image_tooltip")




1. [Extensions] カテゴリの下にある [Statistics Collector] ポリシーを追加します。



<p id="gdcalert149" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image149.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert150">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image149.png "image_tooltip")




1. 次の値を指定して新しい Statistics Collector ポリシーを編集します。

        _<?xml version="1.0" encoding="UTF-8" standalone="yes"?>_


        _<StatisticsCollector async="false" continueOnError="false" enabled="true" name="Statistics-Collector-1">_


        _  &lt;DisplayName>SC-CollectStatistics&lt;/DisplayName>_


        _  &lt;Properties/>_


        _  &lt;Statistics>_


        _    &lt;Statistic name="productID" ref="urirequest.productId" type="STRING"/>_


        _  &lt;/Statistics>_


        _</StatisticsCollector>_

1. トレース セッションを実行します。[Trace] タブをクリックし、[Start Trace Session] をクリックしてトレース セッションを開始します。クエリ パラメータとしていずれかのアプリから API キーを入力してから、[Send] をクリックします。[Extract Variables Policy] アイコンをクリックすると、変数内の値が表示されます。この値は Statistics Collector ポリシーによって記録されます。



<p id="gdcalert150" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image150.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert151">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image150.png "image_tooltip")


さまざまな API からいろいろな API キーを試してみます。

注: それぞれの環境で初めて Statistics Collector ポリシーが呼び出された後、新しいカスタム ディメンションがデータベースに追加されるには 30 分ほどかかります。

たとえば、test 環境で Statistics Collector プロキシが呼び出されると、そのカスタム ディメンションのデータが test 環境で利用できるのは 30 分後になります。そして、カスタム ディメンションは、カスタム レポートの [Dimensions] プルダウン リストに表示されます。


## カスタム レポートを作成する

次に API プロキシで収集したデータを確認しましょう。直前に Statistics Collector ポリシーで定義した値を検索するカスタム レポートを作成する必要があります。



1. [Analyze] > [Custom Reports] > [Reports] で [Custom Reports] メニューを開きます。



<p id="gdcalert151" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image151.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert152">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image151.png "image_tooltip")




1. [+ Custom Report] をクリックして新しいカスタム レポートを作成します。



<p id="gdcalert152" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image152.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert153">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image152.png "image_tooltip")




1. わかりやすいレポート名とレポートの説明を入力します。また、Y 軸に表示する指標を定義します。カスタム統計変数を文字列ではなく整数で定義している場合、その変数もここに表示されます。

たとえば、プロキシのトラフィックを確認してみましょう。

さらに、トラフィックをグループ分けする際のディメンションも定義できます。ディメンションを複数選択すると、レポートをドリルダウンして、トラフィックの指標に関して詳しい情報を得ることができます。



<p id="gdcalert153" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image153.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert154">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image153.png "image_tooltip")




1. このラボでは、この複数のディメンションを使用してドリルダウン機能を紹介します。ここでは [Country]、[Developer App]、[productId] をディメンションに選択します。



<p id="gdcalert154" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image154.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert155">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image154.png "image_tooltip")




1. 選択できるその他のディメンションをご覧ください。Statistics Collector ポリシーで定義した productID だけでなく、Apigee で定義済みの共通ディメンションがあることがわかります。



<p id="gdcalert155" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image155.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert156">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image155.png "image_tooltip")




2. 選択が終わったら右下の [Save] をクリックします。
3. レポートのフィルタリングとして適当な範囲を選択します。すぐに開始するのか、時間がたってから確認するかを決めてください。デフォルトの 1 時間では短すぎるかもしれません。



<p id="gdcalert156" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image156.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert157">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image156.png "image_tooltip")




1. 最初に選択したディメンションで分類されたトラフィックを確認してみましょう。こちらの例ではトラフィックのすべてが IE からのものです。実際のレポートはこの例とは違ったものになり、本番環境ではもっと多様な結果になるでしょう。



<p id="gdcalert157" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image157.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert158">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image157.png "image_tooltip")




1. 青の列をクリックすると、レポートの詳細が表示されます。

次にアプリ別のトラフィックを確認しましょう。注目すべき、トラフィックが多いアプリを簡単に見つけることができます。



<p id="gdcalert158" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image158.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert159">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image158.png "image_tooltip")




1. たとえば、[fg\_Hipster Android App Free] を見てみましょう。



<p id="gdcalert159" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image159.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert160">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image159.png "image_tooltip")




1. 収集されたプロダクト ID 情報を見ることができました。

右側のダウンロード ボタンをクリックすると、データを CSV 形式でダウンロードできます。


## 管理 API で統計情報を入手する

API 呼び出しを簡単に試せる、管理 API ドキュメントを見てみましょう。

https://apidocs.apigee.com/management/apis/get/organizations/%7Borg\_name%7D/environments/%7Benv\_name%7D/stats/%7Bdimension\_name%7D-0


### 値を入力して API 呼び出しを実行する

このドキュメントでは自分の組織に対してインタラクティブに呼び出しを実行し、結果がどうなるか確認できます。



*   API 呼び出しデータを [Resource URL] フィールドの青い箇所に次のように入力します。
    *   {org\_name}: 自分の組織
    *   {env\_name}: 自分の環境
    *   {dimension\_name}: apiproxy
*   表のデータは次のとおりです。
    *   Select: sum(message\_count)
    *   timeRange: 08/01/2019 00:00~08/30/2019 23:59
    *   Filter: (apiproxy eq 'weather-analytics')

注意: 時間の範囲は、現在の終了範囲の日時に合わせて更新してください。



*   管理 UI へのログインに使用する Apigee ユーザー名とパスワードで認証します。
*   [Send this request] ボタンをクリックしてリクエストを送信します。



<p id="gdcalert160" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image160.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert161">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image160.png "image_tooltip")




<p id="gdcalert161" ><span style="color: red; font-weight: bold">>>>>  GDC alert: inline image link here (to images/image161.png). Store image on your image server and adjust path/filename/extension if necessary. </span><br>(<a href="#">Back to top</a>)(<a href="#gdcalert162">Next alert</a>)<br><span style="color: red; font-weight: bold">>>>> </span></p>


![alt_text](images/image161.png "image_tooltip")



## 理解度チェック



*   API 仕様では productId のデータ型に数値が使用されているにもかかわらず、このラボでは文字列を使用したのはなぜでしょうか？
*   プロキシフローに複数の Statistics Collector を配置するとどうなるでしょうか？


## まとめ

このラボでは API プログラムの成果とパフォーマンスを示し、API を最適化するための価値ある分析情報を提供するさまざまなレポートについて説明しました。


## 学習した内容



*   ビルトイン Apigee ダッシュボードの概要
*   カスタム統計データを収集するためのプロキシの変更
*   API 呼び出しから収集したデータを使用してカスタム レポートを作成し、ディメンションを定義してレポートをドリルダウンする


## 参考資料

Apigee ドキュメントへのリンク

https://docs.apigee.com/api-platform/analytics/use-analytics-api-measure-api-program-performance

Analytics ダッシュボードの概要 - https://docs.apigee.com/api-platform/analytics/using-analytics-dashboards

Exract Variables ポリシー - https://docs.apigee.com/api-platform/reference/policies/extract-variables-policy

Statistics Collector ポリシー - https://docs.apigee.com/api-platform/reference/policies/statistics-collector-policy

カスタム レポートの作成と管理 - https://docs.apigee.com/api-platform/analytics/create-custom-reports

Statistics Collector を使用したカスタム レポートの例 - https://docs.apigee.com/api-platform/analytics/analyze-api-message-content-using-custom-analytics


## 動画（4mv4d）

Extract Variables ポリシー - https://www.youtube.com/watch?v=KqFpnNt\_8yo

API の測定と KPI - https://www.youtube.com/watch?v=x6r7xHKNINU

API プログラムの成果の測定とレポート - https://www.youtube.com/watch?v=VcNKpoakVqQ
